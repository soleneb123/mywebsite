---
title: "Mapping My Strava Runs in St. Gallen"
author: "Solène Berney"
format: html
date: 2026-01-04
keywords: [Strava, API, Data Viz, R, OpenStreetMap]
execute:
  eval: false
  freeze: true
css: styles.css

---

# Introduction

I enjoy running, I love learning new coding skills, and especially using them to better understand my direct surroundings and daily habits.

This project visualizes my running activities from **2025** in **St. Gallen**, using data from the **Strava API**, street data from **OpenStreetMap**, and spatial visualization tools in **R**.\
See the final result at the end of the page!


## Step 1: Setup

I start by loading the libraries needed for accessing Strava data, handling spatial data, and creating the final visualization.

```{r}
#| code-fold: true
#| code-summary: "Show setup code"

library(rStrava) # Strava API wrapper
library(sf)
library(googleway)
library(osmdata)
library(dplyr)
library(ggplot2)
library(purrr)
library(lubridate)
library(readr)
library(showtext)
library(ggtext)
library(here)

# Add fonts
font_add_google("Fira Sans", "Fira Sans")  
font_add_google("Bebas Neue", "Bebas Neue")
showtext_auto()
```

## Step 2: Download and cache Strava activities with rStrava API wrapper

Querying the Strava API repeatedly is slow and unnecessary.To avoid this, I cache my activities locally as a CSV file and only download them once after having authentificated with the strava API the first time. Only activities in 2025 with GPS polylines are kept.

```{r}
#| code-fold: true
#| code-summary: "Show Code"


cache_dir <- here("cache")
dir.create(cache_dir, showWarnings = FALSE, recursive = TRUE)
activities_file <- here(cache_dir, "activities_all.csv")

if (!file.exists(activities_file)) {
  
  stoken <- httr::config(
    token = strava_oauth(
      Sys.getenv("STRAVA_APP_NAME"),
      Sys.getenv("STRAVA_CLIENT_ID"),
      Sys.getenv("STRAVA_CLIENT_SECRET"),
      app_scope = "activity:read_all"
    )
  )
  
  activities <- get_activity_list(stoken) |> 
    compile_activities(units = "metric") |> 
    select(id, start_date, type, name, map.summary_polyline) |> 
    filter(!is.na(map.summary_polyline), map.summary_polyline != "") |> 
    mutate(year = year(start_date))
  
  write_csv(activities, activities_file)
  
} else {
  activities <- read_csv(activities_file)
}

activities_2025 <- activities |> filter(year == 2025)
```

## Step 3: Decode GPS Polylines into Spatial Lines

Strava stores GPS tracks as encoded polylines. These are decoded and converted into sf LINESTRING geometries so they can be plotted on a map.

```{r}
#| code-fold: true
#| code-summary: "Show Code"


decode_to_lines <- function(activities_df) {
  lines_list <- map(seq_len(nrow(activities_df)), function(i) {
    if (is.na(activities_df$map.summary_polyline[i]) || 
        activities_df$map.summary_polyline[i] == "") return(NULL)
    
    coords <- tryCatch(
      googleway::decode_pl(activities_df$map.summary_polyline[i]),
      error = function(e) NULL
    )
    if (is.null(coords) || nrow(coords) < 2) return(NULL)
    coords <- filter(coords, !is.na(lat), !is.na(lon))
    if (nrow(coords) < 2) return(NULL)
    line <- st_linestring(as.matrix(coords[, c("lon", "lat")]))
    st_sf(
      id = activities_df$id[i],
      type = activities_df$type[i],
      year = activities_df$year[i],
      geometry = st_sfc(line, crs = 4326)
    )
  })
  do.call(rbind, compact(lines_list))
}

activity_lines <- decode_to_lines(activities_2025)
```

## Step 4: Filter Activities to St. Gallen City

To focus only on runs within St. Gallen, I filter activities using a city-level bounding box and keep only runs intersecting this area.

```{r}
#| code-fold: true
#| code-summary: "Show Code"


stgallen_bbox <- c(xmin = 7.9, xmax = 9.50, ymin = 47.36, ymax = 47.47)
area_sf <- st_as_sfc(st_bbox(stgallen_bbox, crs = 4326))
stgallen_activities <- activity_lines[st_intersects(activity_lines, area_sf, sparse = FALSE)[, 1], ]

activity_bounds <- st_bbox(stgallen_activities)
stgallen_bbox <- activity_bounds[c("xmin","xmax","ymin","ymax")]
```

## Step 5: Get OpenStreetMap Roads

I retrieve street data from OpenStreetMap for the same area. These data are also cached locally to avoid repeated server requests (which can be very, very slow).

```{r}
#| code-fold: true
#| code-summary: "Show Code"

roads_file <- here(cache_dir, "roads_stgallen.gpkg")

if (!file.exists(roads_file)) {
  roads <- opq(bbox = stgallen_bbox, timeout = 90) |>
    add_osm_feature(
      key = "highway",
      value = c("primary", "secondary", "tertiary", "residential")
    ) |>
    osmdata_sf()
  
  st_write(roads$osm_lines, roads_file, quiet = TRUE)
  roads_data <- roads$osm_lines
} else {
  roads_data <- st_read(roads_file, quiet = TRUE)
}
```

## Step 6: Create the map

Finally, I combine the street network and running tracks into a single map using ggplot2.

```{r}
#| code-fold: true
#| code-summary: "Show Code Map Creation"


palette <- list(
  background = "#095229",
  roads = "#FF69B4",
  activities = "#FFF8DC"
)

activity_map <- ggplot() +
  # Roads
  geom_sf(data = roads_data, color = palette$roads, linewidth = 0.3, alpha = 0.9) +
  # Activities
  geom_sf(
    data = stgallen_activities,
    color = palette$activities,
    linewidth = 0.7, alpha = 0.8
  ) +
  # Viewport
  coord_sf(
    xlim = c(stgallen_bbox["xmin"], stgallen_bbox["xmax"]),
    ylim = c(stgallen_bbox["ymin"], stgallen_bbox["ymax"]),
    expand = TRUE, datum = NA
  ) +
  # Labels
  labs(
    title = "<span style='font-size:36pt;'>My Runs in St. Gallen</span>",
    caption = "Data: Strava • Map: OpenStreetMap • Author: Solène Berney",
    subtitle = paste0(
      "<span style='font-size:18pt;'>",
      "2025</span>"
    ),
  ) +
  # Theme
  theme_void() +
  theme(
    plot.background = element_rect(fill = palette$background, color = NA),
    plot.margin = margin(30, 30, 30, 30),
    plot.title = element_markdown(family = "Bebas Neue", hjust = 0.5, color = "#FFF8DC", margin = margin(b = 10)),
    plot.subtitle = element_markdown(family = "Fira Sans", hjust = 0.5, color = "#FFF8DF", margin = margin(b = 15)),
    plot.caption = element_text(family = "Fira Sans", size = 8, color = "#FFF8DC", hjust = 0.95)
  )

```

## Final Result

![My Strava 2025 St Gallen Activity Map](images/stravafinalmap.png){fig-align="center" width="600"}

### References

This project was inspired by a Strava mapping example shared by Prof. Dr. [Aurélien Sallin](https://aureliensallin.ch/posts/blog2/StravaArt.html#references), which I adapted and extended for my own data.
